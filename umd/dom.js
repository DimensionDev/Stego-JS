!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@rgba-image/lanczos")):"function"==typeof define&&define.amd?define(["exports","@rgba-image/lanczos"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).stego={},e.lanczos)}(this,function(e,r){"use strict";let t,o;function n(e,r){return Math.round(Math.random()*r+e)}function l(e,r,t){return e<r?r:e>t?t:e}function a(e,r,t=!1){let o=Array(e.length/3).fill(0).map((e,r)=>r);!function(e,r,t=!1){let o=(r,t)=>([e[r],e[t]]=[e[t],e[r]]);for(let n=t?e.length-1:0;t&&n>=0||!t&&n<e.length;n+=t?-1:1)o(r[n%r.length]%e.length,n)}(o,r,t);let n=Array(e.length).fill(0).map((r,t)=>e[3*o[Math.floor(t/3)]+t%3]);e.forEach((r,t)=>{e[t]=n[t]})}function i(e,r){let t=(e+1)/2-1;return function(e,r){let t=[];for(let o=0;o<e*e;o+=1)r(o)&&t.push(o);return t}(e,o=>Math.sqrt(Math.pow(t-Math.floor(o/e),2)+Math.pow(t-o%e,2))<=r)}function f(e){var r,t;return e&&!(e.length<3)&&255===e[0]&&216===e[1]&&255===e[2]?"image/jpeg":e&&!(e.length<8)&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?"image/png":void 0}function s({p:e,w:r},{size:t}){return[e%Math.floor(r/t)*t,Math.floor(e/Math.floor(r/t))*t]}function h({w:e,c:r},{size:t},o,n,l){return((n+Math.floor(l/t))*e+o+l%t)*4+r}let c=0;function u(e){if(0!==e&&(e&e-1)==0)c=e,t=new Uint8Array(c),o=new Float64Array(1.25*c),function(){let e=0,r=0,o=0;for(t[0]=0;(e+=1)<c;){for(o=c>>1;o<=r;)r-=o,o>>=1;r+=o,t[e]=r}}(),function(){let e=c>>1,r=c>>2,t=c>>3,n=e+r,l=Math.sin(Math.PI/c),a=2*l*l,i=Math.sqrt(a*(2-a)),f=o[r]=1,s=o[0]=0;l=2*a;for(let h=1;h<t;h+=1)f-=a,a+=l*f,s+=i,i-=l*s,o[h]=s,o[r-h]=f;0!==t&&(o[t]=Math.sqrt(.5));for(let u=0;u<r;u+=1)o[e-u]=o[u];for(let m=0;m<n;m+=1)o[m+e]=-o[m]}();else throw Error("init: radix-2 required")}function m(e,r){d(e,r,1)}function g(e,r){let t=1/c;d(e,r,-1);for(let o=0;o<c;o+=1)e[o]*=t,r[o]*=t}function d(e,r,n){let l,a,i,f,s,h,u,m,g;let d=c>>2;for(let A=0;A<c;A+=1)f=t[A],A<f&&(s=e[A],e[A]=e[f],e[f]=s,s=r[A],r[A]=r[f],r[f]=s);for(let T=1;T<c;T<<=1){a=0,l=c/(T<<1);for(let p=0;p<T;p+=1){h=o[a+d],u=n*o[a];for(let M=p;M<c;M+=T<<1)m=h*e[i=M+T]+u*r[i],g=h*r[i]-u*e[i],e[i]=e[M]-m,e[M]+=m,r[i]=r[M]-g,r[M]+=g;a+=l}}}let A=1/Math.sqrt(2);function T(r,t,o,{size:n}){switch(o){case e.TransformAlgorithm.FFT1D:u(n),m(r,t);break;case e.TransformAlgorithm.FFT2D:u(n),function(e,r){let t=[],o=[],n=0;for(let l=0;l<c;l+=1){n=l*c;for(let a=0;a<c;a+=1)t[a]=e[a+n],o[a]=r[a+n];m(t,o);for(let i=0;i<c;i+=1)e[i+n]=t[i],r[i+n]=o[i]}for(let f=0;f<c;f+=1){for(let s=0;s<c;s+=1)n=f+s*c,t[s]=e[n],o[s]=r[n];m(t,o);for(let h=0;h<c;h+=1)e[n=f+h*c]=t[h],r[n]=o[h]}}(r,t);break;case e.TransformAlgorithm.DCT:!function(e,r=8){let t=[];for(let o=0;o<r;o+=1)for(let n=0;n<r;n+=1){let l=0===n?A:1,a=0===o?A:1,i=0;for(let f=0;f<r;f+=1)for(let s=0;s<r;s+=1)i+=e[f*r+s]*Math.cos((2*s+1)*n*Math.PI/16)*Math.cos((2*f+1)*o*Math.PI/16);t.push(i*l*a/4)}for(let h=0;h<t.length;h+=1)e[h]=t[h]}(r,n);break;case e.TransformAlgorithm.FastDCT:!function(e){let r=e.length;if(r<=0||(r&r-1)!=0)throw"Length must be power of 2";!function e(r,t,o,n){if(1===o)return;let l=Math.floor(o/2);for(let a=0;a<l;a+=1){let i=r[t+a],f=r[t+o-1-a];n[t+a]=i+f,n[t+a+l]=(i-f)/(2*Math.cos((a+.5)*Math.PI/o))}e(n,t,l,r),e(n,t+l,l,r);for(let s=0;s<l-1;s+=1)r[t+2*s+0]=n[t+s],r[t+2*s+1]=n[t+s+l]+n[t+s+l+1];r[t+o-2]=n[t+l-1],r[t+o-1]=n[t+o-1]}(e,0,r,new Float64Array(r))}(r);break;default:throw Error(`unknown algorithm in transform: ${o}`)}}function p(r,t,o,{size:n}){switch(o){case e.TransformAlgorithm.FFT1D:u(n),g(r,t);break;case e.TransformAlgorithm.FFT2D:u(n),function(e,r){let t=[],o=[],n=0;for(let l=0;l<c;l+=1){n=l*c;for(let a=0;a<c;a+=1)t[a]=e[a+n],o[a]=r[a+n];g(t,o);for(let i=0;i<c;i+=1)e[i+n]=t[i],r[i+n]=o[i]}for(let f=0;f<c;f+=1){for(let s=0;s<c;s+=1)n=f+s*c,t[s]=e[n],o[s]=r[n];g(t,o);for(let h=0;h<c;h+=1)e[n=f+h*c]=t[h],r[n]=o[h]}}(r,t);break;case e.TransformAlgorithm.DCT:!function(e,r=8){let t=[];for(let o=0;o<r;o+=1)for(let n=0;n<r;n+=1){let l=0;for(let a=0;a<r;a+=1)for(let i=0;i<r;i+=1){let f=0===i?A:1,s=0===a?A:1;l+=f*s*e[a*r+i]*Math.cos((2*n+1)*i*Math.PI/16)*Math.cos((2*o+1)*a*Math.PI/16)}t.push(l/4)}for(let h=0;h<t.length;h+=1)e[h]=t[h]}(r,n);break;case e.TransformAlgorithm.FastDCT:!function(e){let r=e.length;if(r<=0||(r&r-1)!=0)throw"Length must be power of 2";e[0]/=2,function e(r,t,o,n){if(1===o)return;let l=Math.floor(o/2);n[t+0]=r[t+0],n[t+l]=r[t+1];for(let a=1;a<l;a+=1)n[t+a]=r[t+2*a],n[t+a+l]=r[t+2*a-1]+r[t+2*a+1];e(n,t,l,r),e(n,t+l,l,r);for(let i=0;i<l;i+=1){let f=n[t+i],s=n[t+i+l]/(2*Math.cos((i+.5)*Math.PI/o));r[t+i]=f+s,r[t+o-1-i]=f-s}}(e,0,r,new Float64Array(r));for(var t=0;t<e.length;t+=1)e[t]/=e.length/2}(r);break;default:throw Error(`unknown algorithm in inverseTransform: ${o}`)}}e.TransformAlgorithm=void 0,(R=e.TransformAlgorithm||(e.TransformAlgorithm={})).FFT1D="FFT1D",R.FFT2D="FFT2D",R.DCT="DCT",R.FastDCT="fastDCT",e.AlgorithmVersion=void 0,(k=e.AlgorithmVersion||(e.AlgorithmVersion={})).V1="V1",k.V2="V2";let M={[e.AlgorithmVersion.V1]:{[e.TransformAlgorithm.DCT]:100,[e.TransformAlgorithm.FastDCT]:500,[e.TransformAlgorithm.FFT1D]:128,[e.TransformAlgorithm.FFT2D]:500},[e.AlgorithmVersion.V2]:{[e.TransformAlgorithm.DCT]:10,[e.TransformAlgorithm.FastDCT]:100,[e.TransformAlgorithm.FFT1D]:30,[e.TransformAlgorithm.FFT2D]:150}},w={[e.TransformAlgorithm.DCT]:5e3,[e.TransformAlgorithm.FastDCT]:5e3,[e.TransformAlgorithm.FFT1D]:5e3,[e.TransformAlgorithm.FFT2D]:5e4},E=e.AlgorithmVersion.V2,b=[76221,13388,20800,80672,15974,87005,71203,84444,16928,51335,94092,83586,37656,2240,26283,1887,93419,96857,20866,21797,42065,39781,50192,24399,98969,54274,38815,45159,36824];function I({width:e,height:r},{size:t}){return[Math.floor(e/t)*t,Math.floor(r/t)*t]}function D(e,r,t){let{width:o,height:n}=e,l=0,a=0,i=0;for(let f of function*({width:e,height:r,data:t},{size:o,verbose:n}){for(let l=0;l<r;l+=o)for(let a=0;a<e;a+=o)if(l+o<=r&&a+o<=e)for(let i=0;i<3;i+=1){let f=[];for(let s=0;s<o;s+=1)for(let h=0;h<o;h+=1)f[s*o+h]=t[((l+s)*e+a+h)*4+i];n&&console.warn("height: "+l+" width: "+a),yield f}}(e,r)){let s=t(f,{c:l,p:a,b:i,w:o,h:n},e);s&&(i+=1),3===(l+=1)&&(a+=1,l=0)}}function F(e,r,t){!function(e,r,t){let{width:o,height:n,data:l}=e;for(let a=0;a<o*n;a+=1){let i=4*a;t([l[i],l[i+1],l[i+2],l[i+3]],i,e)}}(e,r,(o,n)=>v(e,r,t(o,n,e),n))}function y(e,r,t){D(e,r,(o,n)=>{let a=t(o,n,e);if(a&&(function(e,r,t,o){let{data:n}=e,{size:a}=r,[i,f]=s(o,r);for(let c=0;c<a*a;c+=1)t[c]=l(Math.round(t[c]),0,255),n[h(o,r,i,f,c)]=t[c]}(e,r,o,n),r.verbose)){console.warn("inversed block: "+o);let i=Array(r.size*r.size);T(o,i.fill(0),r.transformAlgorithm,r),console.warn(o[25],o[18])}return a})}function v(e,r,t,o){let{data:n}=e;[n[o],n[o+1],n[o+2],n[o+3]]=t}function O(r,t,o,n){switch(n){case e.GrayscaleAlgorithm.AVERAGE:return(r+t+o)/3;case e.GrayscaleAlgorithm.LUMINANCE:return .3*r+.59*t+.11*o;case e.GrayscaleAlgorithm.LUMINANCE_II:return .2126*r+.7152*t+.0722*o;case e.GrayscaleAlgorithm.DESATURATION:return(Math.max(r,t,o)+Math.min(r,t,o))/2;case e.GrayscaleAlgorithm.MAX_DECOMPOSITION:return Math.max(r,t,o);case e.GrayscaleAlgorithm.MIN_DECOMPOSITION:return Math.min(r,t,o);case e.GrayscaleAlgorithm.MID_DECOMPOSITION:return[r,t,o].sort()[1];case e.GrayscaleAlgorithm.SIGNLE_R:return r;case e.GrayscaleAlgorithm.SIGNLE_G:return t;case e.GrayscaleAlgorithm.SIGNLE_B:return o;default:return 0}}function _(e,r){return l(Math.round(e),r,255-r)}function C({size:r,transformAlgorithm:t}){return t===e.TransformAlgorithm.FFT1D?{prevPos:-1,prevCode:"",indices:i(r,3)}:{prevPos:-1,prevCode:"",indices:[]}}function N(r,t,o){let{pass:n,size:l,transformAlgorithm:a}=o;switch(a){case e.TransformAlgorithm.FFT1D:return n?function(e,{c:r},{pass:t}){let{prevCode:o,prevPos:n,indices:l}=e;if(0!==r)return n;let[a,i]=function(e,r,t){let o=1,n=function(e){let r=0;if(0===e.length)return r;for(let t=0;t<e.length;t+=1){let o=e.charCodeAt(t);r=(r<<5)-r+o,r&=r}return r}(e),l=Math.abs(n)%r;for(;t[l];)l=(l+o*o)%r,o=o>r/2?1:o+1;return t[l]=1,[l,String(n)]}(`${t}_${o}`,l.length,[]);return e.prevCode=i,e.prevPos=l[a],l[a]}(r,t,o):(l*l+l)/2;case e.TransformAlgorithm.FFT2D:case e.TransformAlgorithm.DCT:case e.TransformAlgorithm.FastDCT:return 0;default:throw Error(`unknown algorithm: ${a}`)}}function L(e){let r=Array(e).fill(0);for(let t=0;t<e;t+=1)r[t]=Math.floor(2*Math.random());return r}function P({data:e},r,t){let{size:o}=t,n={...r,c:0},[l,a]=s(n,t);for(let i=0;i<o*o;i+=1){let f=e[h(n,t,l,a,i)];if(void 0!==f&&f<127)return!1}return!0}function S({data:e},r,t){return void 0===e[r]||e[r]>127}async function U(r,t,o){let{text:l,size:a,narrow:i,copies:f,grayscaleAlgorithm:c,transformAlgorithm:u,exhaustPixels:m}=o,[g,d]=I(r,o),A=g*d*3,M=function(e,r){let t=Array.from(e),o=[],n=(e,r)=>{for(let t=0;t<8;t+=1){let n=0;for(;n<r;)o.push(e[t]),n+=1}};for(let l=0;l<t.length;l+=1){let a=Array.from(encodeURI(t[l]));for(let i=0;i<a.length;i+=1){let f=[],s=0,h=a[i].charCodeAt(0);do f.push(s=h%2),h=h-Math.floor(h/2)-s;while(h>1);for(f.push(h);f.length<8;)f.push(0);n(f.reverse(),r)}}return o}(l,f),w=function(e,...r){let t=0;for(let o=0;o<r.length;o+=1){let n=r[o];for(let l=0;l<n.length&&t<e.length;l+=1,t+=1)e[t]=n[l]}return e}(L(m?A:M.length+8*f),M,L(8*f).fill(1));M.length+8*f>A&&process.stderr.write("bits overflow! try to shrink text or reduce copies.\n"),(c!==e.GrayscaleAlgorithm.NONE||i>0)&&F(r,o,([r,o,n,l],a)=>{if(!S(t,a))return[r,o,n,l];if(c!==e.GrayscaleAlgorithm.NONE){let f=O(r,o,n,c);r=f,o=f,n=f}return i>0&&(r=_(r,i),o=_(o,i),n=_(n,i)),[r,o,n,l]});let E=C(o),b=Array(a*a);return y(r,o,(e,l)=>{if(!m&&l.b>=w.length)return!1;if(!P(t,l,o)){if(o.fakeMaskPixels&&0===l.c){let[a,i]=s(l,o),f=n(10,127);v(r,o,[f,f,f,255],h(l,o,a,i,n(0,64)))}return!1}return T(e,b.fill(0),u,o),function(e,r,t,o,n){let l=N(t,o,n),{tolerance:a}=n,i=Math.floor(e[l]/a);r[o.b]?e[l]=i%2==1?i*a:(i+1)*a:e[l]=i%2==1?(i-1)*a:i*a}(e,w,E,l,o),p(e,b,u,o),!0}),r}async function G(e,r,t){let{size:o,copies:n,transformAlgorithm:l}=t,a=[],i=C(t),f=Array(o*o);return D(e,t,(e,o)=>!!P(r,o,t)&&(T(e,f.fill(0),l,t),a.push(function(e,r,t,o){let n=N(r,t,o),{tolerance:l}=o;return Math.abs(Math.round(e[n]/l)%2)}(e,i,o,t)),!0)),function(e,r){let t=128,o=0,n=[],l=[],a=()=>l.filter(e=>1===e).length>=r/2?1:0;for(let i=0;i<e.length;i+=1)if(l.push(e[i]),l.length===r){if(o+=a()*t,t/=2,l.length=0,255===o)break;t<1&&(n.push(String.fromCharCode(o)),o=0,t=128)}try{return decodeURI(n.join(""))}catch(f){return""}}(a,n)}async function x(e,r,t){let{width:o,height:n}=e,[l,a]=I(e,t);return{data:await U(e,r,t),width:t.cropEdgePixels?l:o,height:t.cropEdgePixels?a:n}}e.GrayscaleAlgorithm=void 0,(V=e.GrayscaleAlgorithm||(e.GrayscaleAlgorithm={})).NONE="NONE",V.AVERAGE="AVG",V.LUMINANCE="LUMA",V.LUMINANCE_II="LUMA_II",V.DESATURATION="DESATURATION",V.MAX_DECOMPOSITION="MAX_DE",V.MIN_DECOMPOSITION="MIN_DE",V.MID_DECOMPOSITION="MID_DE",V.SIGNLE_R="R",V.SIGNLE_G="G",V.SIGNLE_B="B";var R,k,V,B=Object.freeze({__proto__:null,encode:x,decode:G});function j(r){let{pass:t,size:o,transformAlgorithm:n}=r;switch(n){case e.TransformAlgorithm.FFT1D:case e.TransformAlgorithm.FFT2D:case e.TransformAlgorithm.DCT:case e.TransformAlgorithm.FastDCT:return[3*o+1,2*o+2];default:throw Error(`unknown algorithm in getPos: ${n}`)}}let z=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","J","H","I","G","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","-",".","_","!","~","*","'","(",")",";",",","/","?",":","@","&","=","+","$","%"],X=z.map((e,r)=>{var t;return(t=2*r)^t>>1}),q=e=>-1!==z.indexOf(e)?X[z.indexOf(e)]:255,$=e=>-1!==X.indexOf(e)?z[X.indexOf(e)]:"";function H(e){let r=Array(e).fill(0);for(let t=0;t<e;t+=1)r[t]=Math.floor(2*Math.random());return r}function K(e,r,t){let[o,n]=j(t);t.verbose&&console.warn("decoded value: ",e[o],e[n]);let l=e[o]-e[n];return{bit:l>0?1:0,diff:l}}async function W(r,t,o){let{text:l,size:i,narrow:f,copies:c,grayscaleAlgorithm:u,transformAlgorithm:m,exhaustPixels:g}=o,[d,A]=I(r,o),M=d*A*3/(i*i),w=function(e,r){let t=function(e){let r=[];return Array.from(e).map(e=>{let t=Array.from(encodeURI(e));t.map(e=>r.push(X[z.indexOf(e)]))}),r}(e);return function(e,r){let t=[],o=(e,r)=>{for(let o=0;o<8;o+=1){let n=0;for(;n<r;)t.push(e[o]),n+=1}};return e.map(e=>{let t=[],n=0;do t.push(n=e%2),e=e-Math.floor(e/2)-n;while(e>1);for(t.push(e);t.length<8;)t.push(0);o(t.reverse(),3*Math.ceil(r/3))}),t}(t,r)}(l,c),E=function(e,r){let t=Array.from(e.toString(2)).reverse().map(e=>Number(e));for(;t.length<4;)t.push(0);let o=[];for(let n=0;n<t.length;n+=1)for(let l=0;l<9;l+=1)o.push(t[n]);return o}((o.copies-1)/2,9),D=function(e,...r){let t=0;for(let o=0;o<r.length;o+=1){let n=r[o];for(let l=0;l<n.length&&t<e.length;l+=1,t+=1)e[t]=n[l]}return e}(H(M),E,w,H(8*c).fill(1)),C=w.length+8*c;C>M&&process.stderr.write("bits overflow! try to shrink text or reduce copies.\n"),(u!==e.GrayscaleAlgorithm.NONE||f>0)&&F(r,o,([r,o,n,l],a)=>{if(!S(t,a))return[r,o,n,l];if(u!==e.GrayscaleAlgorithm.NONE){let i=O(r,o,n,u);r=i,o=i,n=i}return f>0&&(r=_(r,f),o=_(o,f),n=_(n,f)),[r,o,n,l]});let N=Array(i*i),L=-1,U=Array(M).fill(0).map((e,r)=>r);a(U,b);let G=U.map((e,r)=>{if(r<C)return e});return y(r,o,(a,f)=>{if(0===f.c){let[u,d]=s(f,o);for(let A=0;A<i*i;A+=1){let M=h(f,o,u,d,A);!function(e,r,t,o){let{data:n}=e;n[r+3]=255}(r,M,3,255)}}if(L+=1,!g&&!(L in G))return!1;if(!P(t,f,o)){if(o.fakeMaskPixels&&0===f.c){let[w,b]=s(f,o),I=n(10,127);v(r,o,[I,I,I,255],h(f,o,w,b,n(0,64)))}return!1}o.verbose&&console.warn("Encode on image block (blockId: "+L+"): "+a),T(a,N.fill(0),m,o);let F=(()=>{let e=L*i/3%f.w,r=Math.floor(L*i/3/f.w)*i,t=o.tolerance;return(e<=8||e>f.w-2*i||r<=i||r>f.h-2*i)&&(t*=1.5),o.verbose&&console.warn("Encode with tolerance: "+t+" (Image size is width: "+f.w+" height:"+f.h+")"),t})(),y=0,O=5;for(;;){!function(r,t,o,n){let[l,a]=j(o),i=r[l],f=r[a],s=Math.abs(i-f),h=s>1.5*n?.5*n:s<.3*n?1.5*n:s<.5*n?1.2*n:n;[i,f]=i<f?[i-h/2,f+h/2]:[i+h/2,f-h/2],o.verbose&&console.warn("encoded value: ",i,f),t?([r[l],r[a]]=i<f?[f,i]:[i,f],o.transformAlgorithm===e.TransformAlgorithm.FFT2D&&([r[72-l],r[72-a]]=i<f?[f,i]:[i,f])):([r[l],r[a]]=i<f?[i,f]:[f,i],o.transformAlgorithm===e.TransformAlgorithm.FFT2D&&([r[72-l],r[72-a]]=i<f?[i,f]:[f,i]))}(a,D[U[f.b]],o,F);let[_,C]=j(o);if(y=0===y?a[_]-a[C]:y,o.verbose){let S=U[f.b]<E.length?"PARAM_BITS":function(e,r,t){let o=Math.floor(e/(8*r)),n=Array.from(encodeURI(t));return o>n.length?"OUT_OF_BOUND(charId: "+o+")":n[o]+"(charId: "+o+", bitId: "+e%(8*r)+")"}(U[f.b]-E.length,c,l);console.warn("Encode bit: "+D[U[f.b]]+" From char: "+S),console.warn(a)}p(a,N,m,o);let x=a.map(e=>e<0?0:e>255?255:Math.round(e));T(x,N.fill(0),m,o);let R=x[_]-x[C];if(o.verbose&&console.warn("After encode, the params diff is: "+R+" ("+x[_]+"-"+x[C]+") diff1: "+y),Math.abs(R)<Math.abs(.8*y)){if(o.verbose&&console.warn("Repeat set bit with tolerance: "+F+" (max repeat times: "+O+")"),0==(O-=1))break;for(let k=0;k<i*i;k+=1)a[k]=x[k];continue}break}return!0}),r}async function Z(r,t,o){var n;let{size:l,transformAlgorithm:f}=o,s=[],h=function({size:r,transformAlgorithm:t}){return t===e.TransformAlgorithm.FFT1D?{prevPos:-1,prevCode:"",indices:i(r,3)}:{prevPos:-1,prevCode:"",indices:[]}}(o),c=Array(l*l),[u,m]=I(r,o),g=Array(u*m*3/(l*l)).fill(0).map((e,r)=>r);a(g,b);let d=0;D(r,o,(e,r)=>{if(!P(t,r,o))return!1;if(T(e,c.fill(0),f,o),o.verbose&&d>=36){let n=d-36;console.warn("charId: "+Math.floor(g[n]/(8*o.copies))+", bitId: "+g[n]%(8*o.copies)),console.warn("bit: "+K(e,h,o).bit,e)}return s.push(K(e,h,o)),d+=1,!0}),a(s,b,!0);let A=s.slice(0,36).map(e=>e.bit),p=function(e){let r=1+2*function(e,r){let t=1,o=0;for(let n=0;n<e.length/9;n+=1){let l=[];for(let a=0;a<9;a+=1)l.push(e[9*n+a]);let i=()=>l.filter(e=>1===e).length>=4.5?1:0;o+=t*i(),t<<=1}return o}(e);return r}(A);return o.verbose&&console.warn("copies is "+p),function(e,r,t){let o=128,n=0,l=[],a=[],i=[];for(let f=0;f<e.length;f+=1)if(i.push(e[f]),t&&(console.warn("bit: "+e[f].bit),console.warn("charId: "+Math.floor(f/(8*r))+", bitId: "+f%(8*r))),i.length===r){if(l.push(i.slice()),o/=2,i.length=0,o<1){if(255===(n=function(e,r,t){if(t){let o=e.map(e=>e.map(e=>e.bit)),n=e.map(e=>e.map(e=>e.diff));console.warn("[debug][rawcode] bits: "+o+"\n"+n)}let l=e.slice().reverse().reduce((e,r,o)=>{let n=r.length,l=r.filter(e=>1===e.bit).length;if(0===l)return e;if(l!==n){let a=(e,r)=>e.reduce((e,t)=>t.bit===r?e+t.diff:e,0),i=Math.abs(a(r,1))/l,f=Math.abs(a(r,0))/(n-l);t&&console.warn("diff1: "+i+" diff0: "+i),(i>2*f||l>n/2)&&(e+=1<<o)}else e+=1<<o;return e},0);if(255!==l&&-1===X.indexOf(l)){let a=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"].map(e=>q(e)),i=r.length,f=!1;(i>1&&r[i-1]===q("%")||i>2&&r[i-2]===q("%"))&&(f=!0);let s=e=>{let r=0;for(;e;)r+=1&e,e>>=1;return r};l=X.reduce((r,o)=>{if(f){if(-1===a.indexOf(o))return r;if(-1===a.indexOf(r))return o}let n=e=>{let r=Array.from(e.toString(2));for(;r.length<8;)r.splice(0,0,"0");return r.map(e=>Number(e))},i=(e,r)=>{let o=n(r),l=0,a=0,i=[.45,.35,.2];for(let f=0;f<e.length;f+=1){let s=e[f].filter(e=>1===e.bit).length,h=Math.abs(s-o[f]*e[f].length);l+=h,a+=e[f].reduce((e,r,t)=>r.bit!==o[f]?Math.abs(r.diff)*i[t%3]+e:e,0)}return t&&console.warn(r+" "+$(r)+" "+o+" bit difference: "+l+" param difference: "+a+"\n"),[l,a]};if(s(l^r)<s(l^o))return r;{if(s(l^r)>s(l^o))return o;let[h,c]=[i(e,r),i(e,o)];return h[1]<c[1]?r:h[1]>c[1]?o:h[0]<c[0]?r:o}},255)}if(t){let h=e.map(e=>e.map(e=>e.bit)),c=e.map(e=>e.map(e=>e.diff));console.warn("elected "+l+" ("+$(l)+") with bits: "+h+"\n"+c)}return l}(l,a,t)))break;t&&console.warn("bit index: "+f+" char: "+$(n)+" temp: "+n+"\n"),a.push(n),n=0,l.length=0,o=128}r%3!=0&&(f+=3-r%3)}t&&console.warn("Before correctURI: "+a);let s=a.map(e=>$(e));try{return decodeURI(s.join(""))}catch(h){return console.warn("Error when decoding:  "+h),""}}(s.slice(36),p,o.verbose)}async function J(e,r,t){let{width:o,height:n}=e,[l,a]=I(e,t);return{data:await W(e,r,t),width:t.cropEdgePixels?l:o,height:t.cropEdgePixels?a:n}}var Q=Object.freeze({__proto__:null,encode:J,decode:Z});let{encode:Y,decode:ee}=function({algoithms:e,methods:r}){return{async encode(t,o,n){let{data:l,height:a,width:i}=await e[n.version].encode(r.preprocessImage(await r.toImageData(t)),r.preprocessImage(await r.toImageData(o)),n);return r.toBuffer(l,a,i)},decode:async(t,o,n)=>e[n.version].decode(await r.toImageData(t),await r.toImageData(o),n)}}({algoithms:{[e.AlgorithmVersion.V1]:B,[e.AlgorithmVersion.V2]:Q},methods:{toImageData(e){let r=f(new Uint8Array(e.slice(0,8))),t=new Blob([e],{type:r}),o=URL.createObjectURL(t);return new Promise((e,r)=>{let t=new Image;t.addEventListener("load",()=>{let{width:r,height:o}=t,n=et(r,o).getContext("2d");n.drawImage(t,0,0,r,o),e(n.getImageData(0,0,r,o))}),t.addEventListener("error",r),t.src=o})},async toBuffer(e,r=e.height,t=e.width){let o=et(t,r);return(o.getContext("2d").putImageData(e,0,0,0,0,t,r),o?.[Symbol.toStringTag]==="OffscreenCanvas")?er(await o.convertToBlob({type:"image/png"})):new Promise((e,r)=>{let t=t=>{t?e(er(t)):r(Error("fail to generate array buffer"))};o.toBlob(t,"image/png")})},preprocessImage:e=>(function(e,t){if(e.width<=1960&&e.height<=1960)return e;let o=1960/Math.max(e.width,e.height),[n,l]=[e.width*o,e.height*o],a=t(n,l);return a?(r.lanczos(e,a),a):e})(e,(e,r)=>et(e,r).getContext("2d")?.createImageData(e,r)??null)}});function er(e){return new Promise((r,t)=>{let o=new FileReader;o.addEventListener("load",()=>r(o.result)),o.addEventListener("error",()=>t(Error("fail to generate array buffer"))),o.readAsArrayBuffer(e)})}function et(e,r){if("undefined"!=typeof OffscreenCanvas)return new OffscreenCanvas(e,r);let t=document.createElement("canvas");return t.width=e,t.height=r,t}e.CLI_NAME="stego-js",e.DEFAULT_ALGORITHM_VERSION=E,e.DEFAULT_COPIES=3,e.DEFAULT_CROP_EDGE_PIXELS=!0,e.DEFAULT_EXHAUST_PIXELS=!0,e.DEFAULT_FAKE_MASK_PIXELS=!1,e.DEFAULT_MASK=[137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,1,3,0,0,0,37,219,86,202,0,0,0,1,115,82,71,66,1,217,201,44,127,0,0,0,9,112,72,89,115,0,0,11,19,0,0,11,19,1,0,154,156,24,0,0,0,3,80,76,84,69,255,255,255,167,196,27,200,0,0,0,10,73,68,65,84,120,156,99,96,0,0,0,2,0,1,72,175,164,113,0,0,0,0,73,69,78,68,174,66,96,130],e.DEFAULT_NARROW=0,e.DEFAULT_PARAM_COPIES=9,e.DEFAULT_SIZE=8,e.DEFAULT_TOLERANCE=M,e.MAX_TOLERANCE=w,e.MAX_WIDTH=1960,e.SEED=b,e.TOLERANCE_NOT_SET=-1,e.decode=ee,e.encode=Y,e.getImageType=f,Object.defineProperty(e,"__esModule",{value:!0})});
