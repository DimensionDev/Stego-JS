!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@rgba-image/lanczos")):"function"==typeof define&&define.amd?define(["exports","@rgba-image/lanczos"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).stego={},e.lanczos)}(this,function(e,t){"use strict";let r,n;function o(e,t){return Math.round(Math.random()*t+e)}function l(e,t,r){return e<t?t:e>r?r:e}function a(e,t,r=!1){let n=Array(e.length/3).fill(0).map((e,t)=>t);!function(e,t,r=!1){let n=(t,r)=>{[e[t],e[r]]=[e[r],e[t]]};for(let o=r?e.length-1:0;r&&o>=0||!r&&o<e.length;o+=r?-1:1)n(t[o%t.length]%e.length,o)}(n,t,r);let o=Array(e.length).fill(0).map((t,r)=>e[3*n[Math.floor(r/3)]+r%3]);e.forEach((t,r)=>{e[r]=o[r]})}function i(e,t){let r=(e+1)/2-1;return function(e,t){let r=[];for(let n=0;n<e*e;n+=1)t(n)&&r.push(n);return r}(e,n=>Math.sqrt(Math.pow(r-Math.floor(n/e),2)+Math.pow(r-n%e,2))<=t)}function f(e){var t,r;return e&&!(e.length<3)&&255===e[0]&&216===e[1]&&255===e[2]?"image/jpeg":e&&!(e.length<8)&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?"image/png":void 0}function s(t,r,n,o){switch(o){case e.GrayscaleAlgorithm.AVERAGE:return(t+r+n)/3;case e.GrayscaleAlgorithm.LUMINANCE:return .3*t+.59*r+.11*n;case e.GrayscaleAlgorithm.LUMINANCE_II:return .2126*t+.7152*r+.0722*n;case e.GrayscaleAlgorithm.DESATURATION:return(Math.max(t,r,n)+Math.min(t,r,n))/2;case e.GrayscaleAlgorithm.MAX_DECOMPOSITION:return Math.max(t,r,n);case e.GrayscaleAlgorithm.MIN_DECOMPOSITION:return Math.min(t,r,n);case e.GrayscaleAlgorithm.MID_DECOMPOSITION:return[t,r,n].sort()[1];case e.GrayscaleAlgorithm.SIGNLE_R:return t;case e.GrayscaleAlgorithm.SIGNLE_G:return r;case e.GrayscaleAlgorithm.SIGNLE_B:return n;default:return 0}}function c(e,t){return l(Math.round(e),t,255-t)}e.AlgorithmVersion=void 0,(k=e.AlgorithmVersion||(e.AlgorithmVersion={})).V1="V1",k.V2="V2",e.GrayscaleAlgorithm=void 0,(V=e.GrayscaleAlgorithm||(e.GrayscaleAlgorithm={})).NONE="NONE",V.AVERAGE="AVG",V.LUMINANCE="LUMA",V.LUMINANCE_II="LUMA_II",V.DESATURATION="DESATURATION",V.MAX_DECOMPOSITION="MAX_DE",V.MIN_DECOMPOSITION="MIN_DE",V.MID_DECOMPOSITION="MID_DE",V.SIGNLE_R="R",V.SIGNLE_G="G",V.SIGNLE_B="B";let h=0;function u(e){if(0!==e&&(e&e-1)==0)h=e,r=new Uint8Array(h),n=new Float64Array(1.25*h),function(){let e=0,t=0,n=0;for(r[0]=0;(e+=1)<h;){for(n=h>>1;n<=t;)t-=n,n>>=1;t+=n,r[e]=t}}(),function(){let e=h>>1,t=h>>2,r=h>>3,o=e+t,l=Math.sin(Math.PI/h),a=2*l*l,i=Math.sqrt(a*(2-a)),f=n[t]=1,s=n[0]=0;l=2*a;for(let c=1;c<r;c+=1)f-=a,a+=l*f,s+=i,i-=l*s,n[c]=s,n[t-c]=f;0!==r&&(n[r]=Math.sqrt(.5));for(let u=0;u<t;u+=1)n[e-u]=n[u];for(let m=0;m<o;m+=1)n[m+e]=-n[m]}();else throw Error("init: radix-2 required")}function m(e,t){d(e,t,1)}function g(e,t){let r=1/h;d(e,t,-1);for(let n=0;n<h;n+=1)e[n]*=r,t[n]*=r}function d(e,t,o){let l,a,i,f,s,c,u,m,g;let d=h>>2;for(let A=0;A<h;A+=1)f=r[A],A<f&&(s=e[A],e[A]=e[f],e[f]=s,s=t[A],t[A]=t[f],t[f]=s);for(let T=1;T<h;T<<=1){a=0,l=h/(T<<1);for(let p=0;p<T;p+=1){c=n[a+d],u=o*n[a];for(let w=p;w<h;w+=T<<1)m=c*e[i=w+T]+u*t[i],g=c*t[i]-u*e[i],e[i]=e[w]-m,e[w]+=m,t[i]=t[w]-g,t[w]+=g;a+=l}}}let A=1/Math.sqrt(2);function T(t,r,n,{size:o}){switch(n){case e.TransformAlgorithm.FFT1D:u(o),m(t,r);break;case e.TransformAlgorithm.FFT2D:u(o),function(e,t){let r=[],n=[],o=0;for(let l=0;l<h;l+=1){o=l*h;for(let a=0;a<h;a+=1)r[a]=e[a+o],n[a]=t[a+o];m(r,n);for(let i=0;i<h;i+=1)e[i+o]=r[i],t[i+o]=n[i]}for(let f=0;f<h;f+=1){for(let s=0;s<h;s+=1)o=f+s*h,r[s]=e[o],n[s]=t[o];m(r,n);for(let c=0;c<h;c+=1)e[o=f+c*h]=r[c],t[o]=n[c]}}(t,r);break;case e.TransformAlgorithm.DCT:!function(e,t=8){let r=[];for(let n=0;n<t;n+=1)for(let o=0;o<t;o+=1){let l=0===o?A:1,a=0===n?A:1,i=0;for(let f=0;f<t;f+=1)for(let s=0;s<t;s+=1)i+=e[f*t+s]*Math.cos((2*s+1)*o*Math.PI/16)*Math.cos((2*f+1)*n*Math.PI/16);r.push(i*l*a/4)}for(let c=0;c<r.length;c+=1)e[c]=r[c]}(t,o);break;case e.TransformAlgorithm.FastDCT:!function(e){let t=e.length;if(t<=0||(t&t-1)!=0)throw"Length must be power of 2";!function e(t,r,n,o){if(1===n)return;let l=Math.floor(n/2);for(let a=0;a<l;a+=1){let i=t[r+a],f=t[r+n-1-a];o[r+a]=i+f,o[r+a+l]=(i-f)/(2*Math.cos((a+.5)*Math.PI/n))}e(o,r,l,t),e(o,r+l,l,t);for(let s=0;s<l-1;s+=1)t[r+2*s+0]=o[r+s],t[r+2*s+1]=o[r+s+l]+o[r+s+l+1];t[r+n-2]=o[r+l-1],t[r+n-1]=o[r+n-1]}(e,0,t,new Float64Array(t))}(t);break;default:throw Error(`unknown algorithm in transform: ${n}`)}}function p(t,r,n,{size:o}){switch(n){case e.TransformAlgorithm.FFT1D:u(o),g(t,r);break;case e.TransformAlgorithm.FFT2D:u(o),function(e,t){let r=[],n=[],o=0;for(let l=0;l<h;l+=1){o=l*h;for(let a=0;a<h;a+=1)r[a]=e[a+o],n[a]=t[a+o];g(r,n);for(let i=0;i<h;i+=1)e[i+o]=r[i],t[i+o]=n[i]}for(let f=0;f<h;f+=1){for(let s=0;s<h;s+=1)o=f+s*h,r[s]=e[o],n[s]=t[o];g(r,n);for(let c=0;c<h;c+=1)e[o=f+c*h]=r[c],t[o]=n[c]}}(t,r);break;case e.TransformAlgorithm.DCT:!function(e,t=8){let r=[];for(let n=0;n<t;n+=1)for(let o=0;o<t;o+=1){let l=0;for(let a=0;a<t;a+=1)for(let i=0;i<t;i+=1){let f=0===i?A:1,s=0===a?A:1;l+=f*s*e[a*t+i]*Math.cos((2*o+1)*i*Math.PI/16)*Math.cos((2*n+1)*a*Math.PI/16)}r.push(l/4)}for(let c=0;c<r.length;c+=1)e[c]=r[c]}(t,o);break;case e.TransformAlgorithm.FastDCT:!function(e){let t=e.length;if(t<=0||(t&t-1)!=0)throw"Length must be power of 2";e[0]/=2,function e(t,r,n,o){if(1===n)return;let l=Math.floor(n/2);o[r+0]=t[r+0],o[r+l]=t[r+1];for(let a=1;a<l;a+=1)o[r+a]=t[r+2*a],o[r+a+l]=t[r+2*a-1]+t[r+2*a+1];e(o,r,l,t),e(o,r+l,l,t);for(let i=0;i<l;i+=1){let f=o[r+i],s=o[r+i+l]/(2*Math.cos((i+.5)*Math.PI/n));t[r+i]=f+s,t[r+n-1-i]=f-s}}(e,0,t,new Float64Array(t));for(var r=0;r<e.length;r+=1)e[r]/=e.length/2}(t);break;default:throw Error(`unknown algorithm in inverseTransform: ${n}`)}}function w({p:e,w:t},{size:r}){return[e%Math.floor(t/r)*r,Math.floor(e/Math.floor(t/r))*r]}function M({w:e,c:t},{size:r},n,o,l){return((o+Math.floor(l/r))*e+n+l%r)*4+t}e.TransformAlgorithm=void 0,(j=e.TransformAlgorithm||(e.TransformAlgorithm={})).FFT1D="FFT1D",j.FFT2D="FFT2D",j.DCT="DCT",j.FastDCT="fastDCT";let b=Object.freeze({[e.AlgorithmVersion.V1]:{[e.TransformAlgorithm.DCT]:100,[e.TransformAlgorithm.FastDCT]:500,[e.TransformAlgorithm.FFT1D]:128,[e.TransformAlgorithm.FFT2D]:500},[e.AlgorithmVersion.V2]:{[e.TransformAlgorithm.DCT]:10,[e.TransformAlgorithm.FastDCT]:100,[e.TransformAlgorithm.FFT1D]:30,[e.TransformAlgorithm.FFT2D]:150}}),E=Object.freeze({[e.TransformAlgorithm.DCT]:5e3,[e.TransformAlgorithm.FastDCT]:5e3,[e.TransformAlgorithm.FFT1D]:5e3,[e.TransformAlgorithm.FFT2D]:5e4}),I=e.AlgorithmVersion.V2,D=Object.freeze([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,1,3,0,0,0,37,219,86,202,0,0,0,1,115,82,71,66,1,217,201,44,127,0,0,0,9,112,72,89,115,0,0,11,19,0,0,11,19,1,0,154,156,24,0,0,0,3,80,76,84,69,255,255,255,167,196,27,200,0,0,0,10,73,68,65,84,120,156,99,96,0,0,0,2,0,1,72,175,164,113,0,0,0,0,73,69,78,68,174,66,96,130]),F=Object.freeze([76221,13388,20800,80672,15974,87005,71203,84444,16928,51335,94092,83586,37656,2240,26283,1887,93419,96857,20866,21797,42065,39781,50192,24399,98969,54274,38815,45159,36824]);function y({width:e,height:t},{size:r}){return[Math.floor(e/r)*r,Math.floor(t/r)*r]}function O(e,t,r){let{width:n,height:o}=e,l=0,a=0,i=0;for(let f of function*({width:e,height:t,data:r},{size:n,verbose:o}){for(let l=0;l<t;l+=n)for(let a=0;a<e;a+=n)if(l+n<=t&&a+n<=e)for(let i=0;i<3;i+=1){let f=[];for(let s=0;s<n;s+=1)for(let c=0;c<n;c+=1)f[s*n+c]=r[((l+s)*e+a+c)*4+i];o&&console.warn("height: "+l+" width: "+a),yield f}}(e,t)){let s=r(f,{c:l,p:a,b:i,w:n,h:o},e);s&&(i+=1),3===(l+=1)&&(a+=1,l=0)}}function v(e,t){!function(e,t){let{width:r,height:n,data:o}=e;for(let l=0;l<r*n;l+=1){let a=4*l;t([o[a],o[a+1],o[a+2],o[a+3]],a,e)}}(e,(r,n)=>C(e.data,t(r,n),n))}function _(e,t,r){O(e,t,(n,o)=>{let a=r(n,o,e);if(a&&(function(e,t,r,n){let{size:o}=t,[a,i]=w(n,t);for(let f=0;f<o*o;f+=1)r[f]=l(Math.round(r[f]),0,255),e[M(n,t,a,i,f)]=r[f]}(e.data,t,n,o),t.verbose)){console.warn("inversed block: "+n);let i=Array(t.size*t.size);T(n,i.fill(0),t.transformAlgorithm,t),console.warn(n[25],n[18])}return a})}function C(e,t,r){e[r+0]=t[0],e[r+1]=t[1],e[r+2]=t[2],e[r+3]=t[3]}function N({size:t,transformAlgorithm:r}){return r===e.TransformAlgorithm.FFT1D?{prevPos:-1,prevCode:"",indices:i(t,3)}:{prevPos:-1,prevCode:"",indices:[]}}function L(t,r,n){let{pass:o,size:l,transformAlgorithm:a}=n;switch(a){case e.TransformAlgorithm.FFT1D:return o?function(e,{c:t},{pass:r}){let{prevCode:n,prevPos:o,indices:l}=e;if(0!==t)return o;let[a,i]=function(e,t,r){let n=1,o=function(e){let t=0;if(0===e.length)return t;for(let r=0;r<e.length;r+=1){let n=e.charCodeAt(r);t=(t<<5)-t+n,t&=t}return t}(e),l=Math.abs(o)%t;for(;r[l];)l=(l+n*n)%t,n=n>t/2?1:n+1;return r[l]=1,[l,String(o)]}(`${r}_${n}`,l.length,[]);return e.prevCode=i,e.prevPos=l[a],l[a]}(t,r,n):(l*l+l)/2;case e.TransformAlgorithm.FFT2D:case e.TransformAlgorithm.DCT:case e.TransformAlgorithm.FastDCT:return 0;default:throw Error(`unknown algorithm: ${a}`)}}function P(e){let t=Array(e).fill(0);for(let r=0;r<e;r+=1)t[r]=Math.floor(2*Math.random());return t}function U(e,t,r){let{size:n}=r,o={...t,c:0},[l,a]=w(o,r);for(let i=0;i<n*n;i+=1){let f=e[M(o,r,l,a,i)];if(void 0!==f&&f<127)return!1}return!0}function G(e,t){return void 0===e[t]||e[t]>127}async function S(t,r,n){let{text:l,size:a,narrow:i,copies:f,grayscaleAlgorithm:h,transformAlgorithm:u,exhaustPixels:m}=n,[g,d]=y(t,n),A=g*d*3,b=function(e,t){let r=Array.from(e),n=[],o=(e,t)=>{for(let r=0;r<8;r+=1){let o=0;for(;o<t;)n.push(e[r]),o+=1}};for(let l=0;l<r.length;l+=1){let a=Array.from(encodeURI(r[l]));for(let i=0;i<a.length;i+=1){let f=[],s=0,c=a[i].charCodeAt(0);do f.push(s=c%2),c=c-Math.floor(c/2)-s;while(c>1);for(f.push(c);f.length<8;)f.push(0);o(f.reverse(),t)}}return n}(l,f),E=function(e,...t){let r=0;for(let n=0;n<t.length;n+=1){let o=t[n];for(let l=0;l<o.length&&r<e.length;l+=1,r+=1)e[r]=o[l]}return e}(P(m?A:b.length+8*f),b,P(8*f).fill(1));b.length+8*f>A&&process.stderr.write("bits overflow! try to shrink text or reduce copies.\n"),(h!==e.GrayscaleAlgorithm.NONE||i>0)&&v(t,([t,n,o,l],a)=>{if(!G(r,a))return[t,n,o,l];if(h!==e.GrayscaleAlgorithm.NONE){let f=s(t,n,o,h);t=f,n=f,o=f}return i>0&&(t=c(t,i),n=c(n,i),o=c(o,i)),[t,n,o,l]});let I=N(n),D=Array(a*a);return _(t,n,(e,l)=>{if(!m&&l.b>=E.length)return!1;if(!U(r,l,n)){if(n.fakeMaskPixels&&0===l.c){let[a,i]=w(l,n),f=o(10,127);C(t.data,[f,f,f,255],M(l,n,a,i,o(0,64)))}return!1}return T(e,D.fill(0),u,n),function(e,t,r,n,o){let l=L(r,n,o),{tolerance:a}=o,i=Math.floor(e[l]/a);t[n.b]?e[l]=i%2==1?i*a:(i+1)*a:e[l]=i%2==1?(i-1)*a:i*a}(e,E,I,l,n),p(e,D,u,n),!0}),t}async function R(e,t,r){let{size:n,copies:o,transformAlgorithm:l}=r,a=[],i=N(r),f=Array(n*n);return O(e,r,(e,n)=>!!U(t,n,r)&&(T(e,f.fill(0),l,r),a.push(function(e,t,r,n){let o=L(t,r,n),{tolerance:l}=n;return Math.abs(Math.round(e[o]/l)%2)}(e,i,n,r)),!0)),function(e,t){let r=128,n=0,o=[],l=[],a=()=>l.filter(e=>1===e).length>=t/2?1:0;for(let i=0;i<e.length;i+=1)if(l.push(e[i]),l.length===t){if(n+=a()*r,r/=2,l.length=0,255===n)break;r<1&&(o.push(String.fromCharCode(n)),n=0,r=128)}try{return decodeURI(o.join(""))}catch(f){return""}}(a,o)}async function x(e,t,r){let{width:n,height:o}=e,[l,a]=y(e,r);return{data:await S(e,t,r),width:r.cropEdgePixels?l:n,height:r.cropEdgePixels?a:o}}var k,V,j,z=Object.freeze({__proto__:null,encode:x,decode:R});function B(t){let{pass:r,size:n,transformAlgorithm:o}=t;switch(o){case e.TransformAlgorithm.FFT1D:case e.TransformAlgorithm.FFT2D:case e.TransformAlgorithm.DCT:case e.TransformAlgorithm.FastDCT:return[3*n+1,2*n+2];default:throw Error(`unknown algorithm in getPos: ${o}`)}}let X=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","J","H","I","G","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","-",".","_","!","~","*","'","(",")",";",",","/","?",":","@","&","=","+","$","%"],q=X.map((e,t)=>{var r;return(r=2*t)^r>>1});function $(e){return -1!==X.indexOf(e)?q[X.indexOf(e)]:255}function H(e){return -1!==q.indexOf(e)?X[q.indexOf(e)]:""}function K(e){let t=Array(e).fill(0);for(let r=0;r<e;r+=1)t[r]=Math.floor(2*Math.random());return t}function W(e,t,r){let[n,o]=B(r);r.verbose&&console.warn("decoded value: ",e[n],e[o]);let l=e[n]-e[o];return{bit:l>0?1:0,diff:l}}async function Z(t,r,n){let{text:l,size:i,narrow:f,copies:h,grayscaleAlgorithm:u,transformAlgorithm:m,exhaustPixels:g}=n,[d,A]=y(t,n),b=d*A*3/(i*i),E=function(e,t){let r=function(e){let t=[];return Array.from(e).map(e=>{let r=Array.from(encodeURI(e));r.map(e=>t.push(q[X.indexOf(e)]))}),t}(e);return function(e,t){let r=[],n=(e,t)=>{for(let n=0;n<8;n+=1){let o=0;for(;o<t;)r.push(e[n]),o+=1}};return e.map(e=>{let r=[],o=0;do r.push(o=e%2),e=e-Math.floor(e/2)-o;while(e>1);for(r.push(e);r.length<8;)r.push(0);n(r.reverse(),3*Math.ceil(t/3))}),r}(r,t)}(l,h),I=function(e,t){let r=Array.from(e.toString(2)).reverse().map(e=>Number(e));for(;r.length<4;)r.push(0);let n=[];for(let o=0;o<r.length;o+=1)for(let l=0;l<9;l+=1)n.push(r[o]);return n}((n.copies-1)/2,9),D=function(e,...t){let r=0;for(let n=0;n<t.length;n+=1){let o=t[n];for(let l=0;l<o.length&&r<e.length;l+=1,r+=1)e[r]=o[l]}return e}(K(b),I,E,K(8*h).fill(1)),O=E.length+8*h;O>b&&process.stderr.write("bits overflow! try to shrink text or reduce copies.\n"),(u!==e.GrayscaleAlgorithm.NONE||f>0)&&v(t,([t,n,o,l],a)=>{if(!G(r,a))return[t,n,o,l];if(u!==e.GrayscaleAlgorithm.NONE){let i=s(t,n,o,u);t=i,n=i,o=i}return f>0&&(t=c(t,f),n=c(n,f),o=c(o,f)),[t,n,o,l]});let N=Array(i*i),L=-1,P=Array(b).fill(0).map((e,t)=>t);a(P,F);let S=P.map((e,t)=>{if(t<O)return e});return _(t,n,(a,f)=>{if(0===f.c){let[s,c]=w(f,n);for(let u=0;u<i*i;u+=1){let d=M(f,n,s,c,u);!function(e,t,r,n){let{data:o}=e;o[t+3]=255}(t,d,3,255)}}if(L+=1,!g&&!(L in S))return!1;if(!U(r,f,n)){if(n.fakeMaskPixels&&0===f.c){let[A,b]=w(f,n),E=o(10,127);C(t.data,[E,E,E,255],M(f,n,A,b,o(0,64)))}return!1}n.verbose&&console.warn("Encode on image block (blockId: "+L+"): "+a),T(a,N.fill(0),m,n);let F=(()=>{let e=L*i/3%f.w,t=Math.floor(L*i/3/f.w)*i,r=n.tolerance;return(e<=8||e>f.w-2*i||t<=i||t>f.h-2*i)&&(r*=1.5),n.verbose&&console.warn("Encode with tolerance: "+r+" (Image size is width: "+f.w+" height:"+f.h+")"),r})(),y=0,O=5;for(;;){!function(t,r,n,o){let[l,a]=B(n),i=t[l],f=t[a],s=Math.abs(i-f),c=s>1.5*o?.5*o:s<.3*o?1.5*o:s<.5*o?1.2*o:o;[i,f]=i<f?[i-c/2,f+c/2]:[i+c/2,f-c/2],n.verbose&&console.warn("encoded value: ",i,f),r?([t[l],t[a]]=i<f?[f,i]:[i,f],n.transformAlgorithm===e.TransformAlgorithm.FFT2D&&([t[72-l],t[72-a]]=i<f?[f,i]:[i,f])):([t[l],t[a]]=i<f?[i,f]:[f,i],n.transformAlgorithm===e.TransformAlgorithm.FFT2D&&([t[72-l],t[72-a]]=i<f?[i,f]:[f,i]))}(a,D[P[f.b]],n,F);let[v,_]=B(n);if(y=0===y?a[v]-a[_]:y,n.verbose){let G=P[f.b]<I.length?"PARAM_BITS":function(e,t,r){let n=Math.floor(e/(8*t)),o=Array.from(encodeURI(r));return n>o.length?"OUT_OF_BOUND(charId: "+n+")":o[n]+"(charId: "+n+", bitId: "+e%(8*t)+")"}(P[f.b]-I.length,h,l);console.warn("Encode bit: "+D[P[f.b]]+" From char: "+G),console.warn(a)}p(a,N,m,n);let R=a.map(e=>e<0?0:e>255?255:Math.round(e));T(R,N.fill(0),m,n);let x=R[v]-R[_];if(n.verbose&&console.warn("After encode, the params diff is: "+x+" ("+R[v]+"-"+R[_]+") diff1: "+y),Math.abs(x)<Math.abs(.8*y)){if(n.verbose&&console.warn("Repeat set bit with tolerance: "+F+" (max repeat times: "+O+")"),0==(O-=1))break;for(let k=0;k<i*i;k+=1)a[k]=R[k];continue}break}return!0}),t}async function J(t,r,n){var o;let{size:l,transformAlgorithm:f}=n,s=[],c=function({size:t,transformAlgorithm:r}){return r===e.TransformAlgorithm.FFT1D?{prevPos:-1,prevCode:"",indices:i(t,3)}:{prevPos:-1,prevCode:"",indices:[]}}(n),h=Array(l*l),[u,m]=y(t,n),g=Array(u*m*3/(l*l)).fill(0).map((e,t)=>t);a(g,F);let d=0;O(t,n,(e,t)=>{if(!U(r,t,n))return!1;if(T(e,h.fill(0),f,n),n.verbose&&d>=36){let o=d-36;console.warn("charId: "+Math.floor(g[o]/(8*n.copies))+", bitId: "+g[o]%(8*n.copies)),console.warn("bit: "+W(e,c,n).bit,e)}return s.push(W(e,c,n)),d+=1,!0}),a(s,F,!0);let A=s.slice(0,36).map(e=>e.bit),p=function(e){let t=1+2*function(e,t){let r=1,n=0;for(let o=0;o<e.length/9;o+=1){let l=[];for(let a=0;a<9;a+=1)l.push(e[9*o+a]);let i=()=>l.filter(e=>1===e).length>=4.5?1:0;n+=r*i(),r<<=1}return n}(e);return t}(A);return n.verbose&&console.warn("copies is "+p),function(e,t,r){let n=128,o=0,l=[],a=[],i=[];for(let f=0;f<e.length;f+=1)if(i.push(e[f]),r&&(console.warn("bit: "+e[f].bit),console.warn("charId: "+Math.floor(f/(8*t))+", bitId: "+f%(8*t))),i.length===t){if(l.push(i.slice()),n/=2,i.length=0,n<1){if(255===(o=function(e,t,r){if(r){let n=e.map(e=>e.map(e=>e.bit)),o=e.map(e=>e.map(e=>e.diff));console.warn("[debug][rawcode] bits: "+n+"\n"+o)}let l=e.slice().reverse().reduce((e,t,n)=>{let o=t.length,l=t.filter(e=>1===e.bit).length;if(0===l)return e;if(l!==o){let a=(e,t)=>e.reduce((e,r)=>r.bit===t?e+r.diff:e,0),i=Math.abs(a(t,1))/l,f=Math.abs(a(t,0))/(o-l);r&&console.warn("diff1: "+i+" diff0: "+i),(i>2*f||l>o/2)&&(e+=1<<n)}else e+=1<<n;return e},0);if(255!==l&&-1===q.indexOf(l)){let a=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"].map(e=>$(e)),i=t.length,f=!1;(i>1&&t[i-1]===$("%")||i>2&&t[i-2]===$("%"))&&(f=!0);let s=e=>{let t=0;for(;e;)t+=1&e,e>>=1;return t};l=q.reduce((t,n)=>{if(f){if(-1===a.indexOf(n))return t;if(-1===a.indexOf(t))return n}let o=e=>{let t=Array.from(e.toString(2));for(;t.length<8;)t.splice(0,0,"0");return t.map(e=>Number(e))},i=(e,t)=>{let n=o(t),l=0,a=0,i=[.45,.35,.2];for(let f=0;f<e.length;f+=1){let s=e[f].filter(e=>1===e.bit).length,c=Math.abs(s-n[f]*e[f].length);l+=c,a+=e[f].reduce((e,t,r)=>t.bit!==n[f]?Math.abs(t.diff)*i[r%3]+e:e,0)}return r&&console.warn(t+" "+H(t)+" "+n+" bit difference: "+l+" param difference: "+a+"\n"),[l,a]};if(s(l^t)<s(l^n))return t;{if(s(l^t)>s(l^n))return n;let[c,h]=[i(e,t),i(e,n)];return c[1]<h[1]?t:c[1]>h[1]?n:c[0]<h[0]?t:n}},255)}if(r){let c=e.map(e=>e.map(e=>e.bit)),h=e.map(e=>e.map(e=>e.diff));console.warn("elected "+l+" ("+H(l)+") with bits: "+c+"\n"+h)}return l}(l,a,r)))break;r&&console.warn("bit index: "+f+" char: "+H(o)+" temp: "+o+"\n"),a.push(o),o=0,l.length=0,n=128}t%3!=0&&(f+=3-t%3)}r&&console.warn("Before correctURI: "+a);let s=a.map(e=>H(e));try{return decodeURI(s.join(""))}catch(c){return console.warn("Error when decoding:  "+c),""}}(s.slice(36),p,n.verbose)}async function Q(e,t,r){let{width:n,height:o}=e,[l,a]=y(e,r);return{data:await Z(e,t,r),width:r.cropEdgePixels?l:n,height:r.cropEdgePixels?a:o}}var Y=Object.freeze({__proto__:null,encode:Q,decode:J});let ee={[e.AlgorithmVersion.V1]:z,[e.AlgorithmVersion.V2]:Y},{encode:et,decode:er}=function({preprocessImage:e,toPNG:t,toImageData:r}){return{async encode(n,o,l){let{data:a,height:i,width:f}=await ee[l.version].encode(e(await r(n)),e(await r(o)).data,l);return t(a,i,f)},decode:async(e,t,n)=>ee[n.version].decode(await r(e),(await r(t)).data,n)}}({toImageData:e=>new Promise(t=>{let r=new Uint8Array(e),n=f(r),o=new Blob([r],{type:n});t(el(o))}),async toPNG(e,t=e.height,r=e.width){var n;let o=eo(r,t),l=o.getContext("2d");return(l.putImageData(e,0,0,0,0,r,t),n=o,"function"==typeof OffscreenCanvas&&n instanceof OffscreenCanvas)?o.convertToBlob({type:"image/png"}).then(en):new Promise((e,t)=>{o.toBlob(r=>{r?e(en(r)):t(Error("fail to convert to png"))},"image/png")})},preprocessImage:e=>(function(e,r){if(e.width<=1960&&e.height<=1960)return e;let n=1960/Math.max(e.width,e.height),[o,l]=[e.width*n,e.height*n],a=r(o,l);return a?(t.lanczos(e,a),a):e})(e,(e,t)=>eo(e,t).getContext("2d")?.createImageData(e,t)??null)});function en(e){return new Promise((t,r)=>{let n=new FileReader;n.addEventListener("load",()=>t(new Uint8Array(n.result))),n.addEventListener("error",()=>r(Error("fail to generate array buffer"))),n.readAsArrayBuffer(e)})}function eo(e,t){let r;return"function"==typeof OffscreenCanvas?r=new OffscreenCanvas(e,t):((r=document.createElement("canvas")).width=e,r.height=t),r}async function el(e){let t,r,n;if("function"==typeof createImageBitmap)t=(n=await createImageBitmap(e)).width,r=n.height;else{let o=URL.createObjectURL(e);n=await new Promise((e,n)=>{let l=new Image;l.addEventListener("load",()=>{t=l.width,r=l.height,e(l)}),l.addEventListener("error",n),l.src=o}).finally(()=>URL.revokeObjectURL(o))}let l=eo(t,r),a=l.getContext("2d");return a.drawImage(n,0,0),a.getImageData(0,0,t,r)}e.CLI_NAME="stego-js",e.DEFAULT_ALGORITHM_VERSION=I,e.DEFAULT_COPIES=3,e.DEFAULT_CROP_EDGE_PIXELS=!0,e.DEFAULT_EXHAUST_PIXELS=!0,e.DEFAULT_FAKE_MASK_PIXELS=!1,e.DEFAULT_MASK=D,e.DEFAULT_NARROW=0,e.DEFAULT_PARAM_COPIES=9,e.DEFAULT_SIZE=8,e.DEFAULT_TOLERANCE=b,e.MAX_TOLERANCE=E,e.MAX_WIDTH=1960,e.SEED=F,e.TOLERANCE_NOT_SET=-1,e.decode=er,e.encode=et,e.getImageType=f,Object.defineProperty(e,"__esModule",{value:!0})});
